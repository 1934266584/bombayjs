!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).Bombay=t()}(this,function(){"use strict";var p=function(){return(p=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)},s={reportUrl:"http://localhost:10000",token:"",appVersion:"1.0.0",environment:"production",outtime:300,enableSPA:!0,autoSendPv:!0,isPage:!0,isAjax:!0,isResource:!0,isError:!0,isRecord:!0,isBehavior:!0,ignore:{ignoreErrors:[],ignoreUrls:[],ignoreApis:["/api/v1/report/web","livereload.js?snipver=1","/sockjs-node/info"]},behavior:{console:!0,click:!0},maxLength:1e3};function c(e){return e&&s[e]?s[e]:{}}function n(){}function t(){for(var e,t,n=20,o=new Array(n),r=Date.now().toString(36).split("");0<n--;)t=(e=36*Math.random()|0).toString(36),o[n]=e%3?t:t.toUpperCase();for(var i=0;i<8;i++)o.splice(3*i+2,0,r[i]);return o.join("")}function o(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")}function f(e,t){var n=0,o=e.length;if(function(e,t){var n=Object.prototype.toString.call(e).substring(8).replace("]","");return t?n===t:n}(e,"Array"))for(;n<o&&!1!==t.call(e[n],e[n],n);n++);else for(var r in e)if(!1===t.call(e[r],e[r],r))break;return e}function e(n,o,r){window.addEventListener?window.addEventListener(n,function e(t){r&&window.removeEventListener(n,e,!0),o.call(this,t)},!0):window.attachEvent&&window.attachEvent("on"+n,function e(t){r&&window.detachEvent("on"+n,e),o.call(this,t)})}function r(e,t){return t&&(window.removeEventListener?window.removeEventListener(e,t):window.detachEvent&&window.detachEvent(e,t)),this}function i(e){return(e?h(e.replace(/^#\/?/,"")):"")||"[index]"}function v(e,t){var n;window.CustomEvent?n=new CustomEvent(e,{detail:t}):((n=window.document.createEvent("HTMLEvents")).initEvent(e,!1,!0),n.detail=t),window.dispatchEvent(n)}function a(e){var t=e.split("::");return 1<t.length?{group:t[0],key:t[1]}:{group:"default_group",key:t[0]}}var h=function(e){return e&&"string"==typeof e?e.replace(/^(https?:)?\/\//,"").replace(/\?.*$/,""):""},w=function(){var e="object"==typeof console?console.warn:n;try{var t={warn:e};t.warn.call(t)}catch(e){return n}return e}(),u={page:"",sid:"",sBegin:Date.now(),_health:{errcount:0,apisucc:0,apifail:0}};function d(e){u.page=e}function l(){u.sid=t(),u.sBegin=Date.now()}function g(e,t){"error"===e&&u._health.errcount++,"api"===e&&t&&u._health.apisucc++,"api"!==e||t||u._health.apifail++}function y(){var e=navigator.connection;return{t:"",page:u.page?u.page:location.pathname.toLowerCase(),times:1,v:s.appVersion,token:s.token,e:s.environment,begin:(new Date).getTime(),uid:function(){var e=localStorage.getItem("bombay_uid")||"";e||(e=t(),localStorage.setItem("bombay_uid",e));return e}(),sid:u.sid,sr:screen.width+"x"+screen.height,vp:function(){var e=document.documentElement.clientWidth||document.body.clientWidth,t=document.documentElement.clientHeight||document.body.clientHeight;return e+"x"+t}(),ct:e?e.effectiveType:"",ul:function(){var e=navigator.language||navigator.userLanguage;return e=e.substr(0,2)}(),_v:"1.0.3"}}function m(e){return"res"===e.t?b(e):"error"===e.t?b(e):"behavior"===e.t?b(e):"health"===e.t&&window&&window.navigator&&"function"==typeof window.navigator.sendBeacon?function(e){"object"==typeof e&&(e=o(e)),window&&window.navigator&&"function"==typeof window.navigator.sendBeacon?window.navigator.sendBeacon(s.reportUrl,e):w("[arms] navigator.sendBeacon not surported")}(e):b(e),this}function b(e){var t=e[e.t];delete e[e.t],function(e,t){var n=window.__oXMLHttpRequest_||window.XMLHttpRequest;if("function"==typeof n)try{var o=new n;o.open("POST",e,!0),o.setRequestHeader("Content-Type","text/plain"),o.send(JSON.stringify(t))}catch(e){w("[bombayjs] Failed to log, POST请求失败")}else w("[bombayjs] Failed to log, 浏览器不支持XMLHttpRequest")}(s.reportUrl+"?"+o(e),t)}function L(){var e=y();m(p({},e,{t:"pv",dt:document.title,dl:location.href,dr:document.referrer,dpr:window.devicePixelRatio,de:document.charset}))}function E(e){var t,n,o,r,i,a=[];if(!e||!e.tagName)return"";if(a.push(e.tagName.toLowerCase()),e.id&&a.push("#".concat(e.id)),(t=e.className)&&"[object String]"===Object.prototype.toString.call(t))for(n=t.split(/\s+/),i=0;i<n.length;i++)a.push(".".concat(n[i]));var s=["type","name","title","alt"];for(i=0;i<s.length;i++)o=s[i],(r=e.getAttribute(o))&&a.push("[".concat(o,'="').concat(r,'"]'));return a.join("")}function R(e){var t;try{t=e.target}catch(e){t="<unknown>"}if(0!==t.length){var n={type:"ui.click",data:{message:function(e){if(!e||1!==e.nodeType)return"";for(var t=e||null,n=[],o=0,r=0,i=" > ".length,a="";t&&o++<5&&!("html"===(a=E(t))||1<o&&80<=r+n.length*i+a.length);)n.push(a),r+=a.length,t=t.parentNode;return n.reverse().join(" > ")}(t)}};if(!n.data.message)return;var o=y();m(p({},o,{t:"behavior",behavior:n}))}}var _=["","fetchStart","domainLookupStart","domainLookupEnd","connectStart","connectEnd","requestStart","responseStart","responseEnd","","domInteractive","","domContentLoadedEventEnd","","loadEventStart","","msFirstPaint","secureConnectionStart"];function j(e){var t=i(location.hash);t&&x(t)}function S(e){var t=i(e.detail);t&&x(t)}function x(e){k(),setTimeout(function(){d(e),l(),L()},300)}function k(){var e=u._health.errcount?0:1,t=y(),n=p({},t,u._health,{t:"health",healthy:e,stay:Date.now()-u.sBegin});u._health={errcount:0,apisucc:0,apifail:0},m(n)}function A(e){switch(e.type){case"error":e instanceof ErrorEvent?function(e){var t=y(),n=e.name||"CustomError",o=e.message||"",r=e.error.stack||"";m(p({},t,{t:"error",st:"caughterror",cate:n,msg:o&&o.substring(0,1e3),detail:r&&r.substring(0,1e3),file:e.filename||"",line:e.lineno||"",col:e.colno||""}))}(e):function(e){var t=y(),n=e.target;m(p({},t,{t:"error",st:"resource",msg:n.outerHTML,file:n.src,stack:n.localName.toUpperCase()}))}(e);break;case"unhandledrejection":!function(e){console.log(e);var t=y();m(p({},t,{t:"error",st:"promise",msg:e.reason}))}(e)}g("error")}function C(){var e=window.performance;if(!e||"object"!=typeof e||"function"!=typeof e.getEntriesByType)return null;var t=y(),i=p({},t,{dom:0,load:0,t:"res",res:""}),a=e.timing||{},n=e.getEntriesByType("resource")||[];if("function"==typeof window.PerformanceNavigationTiming){var o=e.getEntriesByType("navigation")[0];o&&(a=o)}f({dom:[10,8],load:[14,1]},function(e,t){var n=a[_[e[1]]],o=a[_[e[0]]];if(0<n&&0<o){var r=Math.round(o-n);0<=r&&r<36e5&&(i[t]=r)}}),n=n.filter(function(t){return!(-1<c("ignore").ignoreApis.findIndex(function(e){return-1<t.name.indexOf(e)}))}),i.res=JSON.stringify(n),m(i)}function P(t,e,n,o,r,i){if(t){g("api",e);var a=y(),s=p({},a,{t:"api",beigin:i,url:t,success:e,time:n,code:o,msg:r});-1<c("ignore").ignoreApis.findIndex(function(e){return-1<t.indexOf(e)})||m(s)}else w("[retcode] api is null")}function T(f){var l=history[f];"function"==typeof l&&(history[f]=function(e,t,n){var o=1===arguments.length?[e]:Array.apply(null,arguments),r=location.href,i=l.apply(history,o);if(!n||"string"!=typeof n)return i;if(n===r)return i;try{var a=r.split("#"),s=n.split("#"),c=h(a[0]),u=h(s[0]),d=a[1]&&a[1].replace(/^\/?(.*)/,"$1"),p=s[1]&&s[1].replace(/^\/?(.*)/,"$1");c!==u?v("historystatechange",u):d!==p&&v("historystatechange",p)}catch(e){w("[retcode] error in "+f+": "+e)}return i},history[f].toString=function(e){return function(){return e+"() { [native code] }"}}(f))}function B(){!function(){if("function"==typeof window.fetch){var r=window.fetch;window.__oFetch_=r,window.fetch=function(e,t){var n=1===arguments.length?[e]:Array.apply(null,arguments),i=Date.now(),o=(e&&"string"!=typeof e?e.url:e)||"",a=h(o);return a?r.apply(window,n).then(function(e){var t=e.clone(),n=t.headers;if(n&&"function"==typeof n.get){var o=n.get("content-type");if(o&&!/(text)|(json)/.test(o))return e}var r=Date.now()-i;return t.text().then(function(e){t.ok?P(a,!0,r,status,e.substr(0,1e3)||"",i):P(a,!1,r,status,e.substr(0,1e3)||"",i)}),e}):r.apply(window,n)}}}(),function(){if("function"==typeof window.XMLHttpRequest){var i=0,a="",n=window.XMLHttpRequest;window.__oXMLHttpRequest_=n,window.XMLHttpRequest=function(e){var o=new n(e);if(!o.addEventListener)return o;var r=o.open,t=o.send;return o.open=function(e,t){var n=1===arguments.length?[e]:Array.apply(null,arguments);a=h(t=t),r.apply(o,n)},o.send=function(){i=Date.now();var e=1===arguments.length?[arguments[0]]:Array.apply(null,arguments);t.apply(o,e)},o.onreadystatechange=function(){if(a&&4===o.readyState){var e=Date.now()-i;if(200<=o.status&&o.status<=299){var t=o.status||200;if("function"==typeof o.getResponseHeader){var n=o.getResponseHeader("Content-Type");if(n&&!/(text)|(json)/.test(n))return}P(a,!0,e,t,o.responseText.substr(0,s.maxLength)||"",i)}else P(a,!1,e,t||"FAILED",o.responseText.substr(0,s.maxLength)||"",i)}},o}}}()}function H(e,t){this.init(e)}return H.prototype.init=function(e){!e||e.token?(function(e){s=p({},s,e)}(e),d(location.pathname.toLowerCase()),l(),s.autoSendPv&&this.sendPv(),s.isPage&&this.sendPerf(),s.enableSPA&&this.addListenRouterChange(),s.isError&&this.addListenJs(),s.isAjax&&this.addListenAjax(),s.isRecord&&this.addRrweb(),s.isBehavior&&this.addListenBehavior(),s.isResource&&this.sendResource(),(window.__bb=this).addListenUnload(),window.__onpopstate_=window.onpopstate,window.onpopstate=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];if(x(window.location.href),window.__onpopstate_)return window.__onpopstate_.apply(this,t)}):console.warn("请输入一个token")},H.prototype.sendPv=function(){L()},H.prototype.sendPerf=function(){!function(){var e=window.performance;if(e&&"object"==typeof e){var i={},a=e.timing||{},t=Date.now(),s=1;if("function"==typeof window.PerformanceNavigationTiming){var n=e.getEntriesByType("navigation")[0];n&&(a=n,s=2)}f({dns:[3,2],tcp:[5,4],ssl:[5,17],ttfb:[7,6],trans:[8,7],dom:[10,8],res:[14,12],firstbyte:[7,2],fpt:[8,1],tti:[10,1],ready:[12,1],load:[14,1]},function(e,t){var n=a[_[e[1]]],o=a[_[e[0]]];if(2===s||0<n&&0<o){var r=Math.round(o-n);0<=r&&r<36e5&&(i[t]=r)}});var o=window.navigator.connection,r=e.navigation||{type:void 0};i.ct=o?o.effectiveType||o.type:"";var c=o&&(o.downlink||o.downlinkMax||o.bandwidth)||null;if((c=999<c?999:c)&&(i.bandwidth=c),i.navtype=1===r.type?"Reload":"Other",1===s&&0<a[_[16]]&&0<a[_[1]]){var u=a[_[16]]-a[_[1]];0<=u&&u<36e5&&(i.fpt=u)}1===s&&0<a[_[1]]?i.begin=a[_[1]]:2===s&&0<i.load?i.begin=t-i.load:i.begin=t;var d=y();m(p({},d,{t:"perf"},i))}}()},H.prototype.sendResource=function(){"complete"===window.document.readyState?C():this.addListenResource()},H.prototype.addListenResource=function(){e("load",C)},H.prototype.addListenBehavior=function(){s.behavior.console&&function(){if(window&&window.console)for(var e=["debug","info","warn","log","error"],t=0;e.length;t++){var n=e[t],o=window.console[n];if(!window.console[n])return;!function(r,i){window.console[r]=function(){var e,t,n=Array.prototype.slice.apply(arguments),o={type:"console",data:{level:r,message:JSON.stringify(n)}};e=o,t=y(),m(p({},t,{t:"behavior",behavior:e})),i&&i.apply(null,n)}}(n,o)}}(),s.behavior.click&&this.addListenClick()},H.prototype.addListenClick=function(){e("click",R),e("keypress",R)},H.prototype.addListenRouterChange=function(){T("pushState"),T("replaceState"),e("hashchange",j),e("historystatechange",S)},H.prototype.addListenJs=function(){e("error",A),e("unhandledrejection",A)},H.prototype.addListenAjax=function(){B()},H.prototype.addListenUnload=function(){e("beforeunload",k)},H.prototype.addRrweb=function(){},H.prototype.removeListenRouterChange=function(){r("hashchange",j),r("historystatechange",S)},H.prototype.removeListenJs=function(){r("error",A),r("unhandledrejection",A)},H.prototype.removeListenResource=function(){r("beforeunload",k)},H.prototype.removeListenAjax=function(){},H.prototype.removeListenUnload=function(){r("load",C)},H.prototype.removeRrweb=function(){},H.prototype.sum=function(e,t){!function(e,t){void 0===t&&(t=1);var n=y(),o=a(e);m(p({},n,o,{t:"sum",val:t}))}(e,t)},H.prototype.avg=function(e,t){!function(e,t){void 0===t&&(t=1);var n=y(),o=a(e);m(p({},n,o,{t:"avg",val:t}))}(e,t)},H.prototype.msg=function(e){!function(e){var t=y(),n=a(e);m(p({},t,{t:"msg",group:n.group,msg:n.key.substr(0,s.maxLength)}))}(e)},H.prototype.destroy=function(){s.enableSPA&&this.removeListenRouterChange(),s.isError&&this.removeListenJs(),s.isAjax&&this.removeListenAjax(),s.isRecord&&this.removeRrweb(),s.isResource&&this.removeListenResource(),this.removeListenResource()},H});
