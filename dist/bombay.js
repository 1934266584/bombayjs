!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).Bombay=t()}(this,function(){"use strict";var p=function(){return(p=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)},v={reportUrl:"http://localhost:10000",token:"",appVersion:"1.0.0",environment:"production",outtime:300,enableSPA:!0,autoSendPv:!0,isPage:!0,isAjax:!0,isResource:!0,isError:!0,isRecord:!0,isBehavior:!0,ignore:{ignoreErrors:[],ignoreUrls:[],ignoreApis:["/api/v1/report/web","livereload.js?snipver=1","/sockjs-node/info"]},behavior:{console:["log","error"],click:!0},maxLength:1e3};function c(e){return e&&v[e]?v[e]:{}}function n(){}function o(){for(var e,t,n=20,o=new Array(n),r=Date.now().toString(36).split("");0<n--;)t=(e=36*Math.random()|0).toString(36),o[n]=e%3?t:t.toUpperCase();for(var a=0;a<8;a++)o.splice(3*a+2,0,r[a]);return o.join("")}function r(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")}function l(e,t){var n=0,o=e.length;if(function(e,t){var n=Object.prototype.toString.call(e).substring(8).replace("]","");return t?n===t:n}(e,"Array"))for(;n<o&&!1!==t.call(e[n],e[n],n);n++);else for(var r in e)if(!1===t.call(e[r],e[r],r))break;return e}function h(e,t){var n;window.CustomEvent?n=new CustomEvent(e,{detail:t}):((n=window.document.createEvent("HTMLEvents")).initEvent(e,!1,!0),n.detail=t),window.dispatchEvent(n)}function a(e){var t=e.split("::");return 1<t.length?{group:t[0],key:t[1]}:{group:"default_group",key:t[0]}}var t=function(n,o,r){window.addEventListener?window.addEventListener(n,function e(t){r&&window.removeEventListener(n,e,!0),o.call(this,t)},!0):window.attachEvent&&window.attachEvent("on"+n,function e(t){r&&window.detachEvent("on"+n,e),o.call(this,t)})},e=function(e,t){return t&&(window.removeEventListener?window.removeEventListener(e,t):window.detachEvent&&window.detachEvent(e,t)),this},w=function(e){return(e?g(e.replace(/^#\/?/,"")):"")||"[index]"},g=function(e){return e&&"string"==typeof e?e.replace(/^(https?:)?\/\//,"").replace(/\?.*$/,""):""},y=function(){var e="object"==typeof console?console.warn:n;try{var t={warn:e};t.warn.call(t)}catch(e){return n}return e}(),i=self!=top,s={page:"",sid:"",sBegin:Date.now(),_health:{errcount:0,apisucc:0,apifail:0},circle:!1,cssInserted:!1};function u(e,t){"error"===e&&s._health.errcount++,"api"===e&&t&&s._health.apisucc++,"api"!==e||t||s._health.apifail++}function f(){var e=navigator.connection;return{t:"",page:s.page?s.page:location.pathname.toLowerCase(),times:1,v:v.appVersion,token:v.token,e:v.environment,begin:(new Date).getTime(),uid:function(){var e=localStorage.getItem("bombay_uid")||"";e||(e=o(),localStorage.setItem("bombay_uid",e));return e}(),sid:s.sid,sr:screen.width+"x"+screen.height,vp:function(){var e=document.documentElement.clientWidth||document.body.clientWidth,t=document.documentElement.clientHeight||document.body.clientHeight;return e+"x"+t}(),ct:e?e.effectiveType:"",ul:function(){var e=navigator.language||navigator.userLanguage;return e=e.substr(0,2)}(),_v:"1.0.9",o:location.href}}function m(e){return"res"===e.t?d(e):"error"===e.t?d(e):"behavior"===e.t?d(e):"health"===e.t&&window&&window.navigator&&"function"==typeof window.navigator.sendBeacon?function(e){"object"==typeof e&&(e=r(e)),e=v.reportUrl+"?"+e,window&&window.navigator&&"function"==typeof window.navigator.sendBeacon?window.navigator.sendBeacon(e):y("[arms] navigator.sendBeacon not surported")}(e):d(e),this}function d(e){var t,n=e[e.t];delete e[e.t],function(e,t){var n=window.__oXMLHttpRequest_||window.XMLHttpRequest;if("function"==typeof n)try{var o=new n;o.open("POST",e,!0),o.setRequestHeader("Content-Type","text/plain"),o.send(JSON.stringify(t))}catch(e){y("[bombayjs] Failed to log, POST请求失败")}else y("[bombayjs] Failed to log, 浏览器不支持XMLHttpRequest")}(v.reportUrl+"?"+r(e),((t={})[e.t]=n,t))}var b="bombayjs-circle-active",L="bombayjs-circle-css";function E(e){var t,n,o,r,a,i=[];if(!e||!e.tagName)return"";if(i.push(e.tagName.toLowerCase()),e.id&&i.push("#".concat(e.id)),(t=e.className)&&"[object String]"===Object.prototype.toString.call(t))for(n=t.split(/\s+/),a=0;a<n.length;a++)n[a].indexOf("active")<0&&i.push(".".concat(n[a]));var s=["type","name","title","alt"];for(a=0;a<s.length;a++)o=s[a],(r=e.getAttribute(o))&&i.push("[".concat(o,'="').concat(r,'"]'));return i.join("")}function _(e){if(!e||1!==e.nodeType)return"";var t=[],n=0,o="";t.push("("+e.innerText.substr(0,50)+")");for(var r=e||null;r&&n++<5&&"html"!==(o=E(r));)t.push(o),r=r.parentNode;return t.reverse().join(" > ")}function R(e){if(s.circle){var t=e.target.className.split(/\s+/),n=_(e.target);return n=1===t.length||2===t.length&&""===t[0]?n.replace(/\.\.bombayjs-circle-active/,""):n.replace(/\.bombayjs-circle-active/,""),window.parent.postMessage({t:"setElmPath",path:n,page:s.page},"*"),void e.stopPropagation()}var o;try{o=e.target}catch(e){o="<unknown>"}if("INPUT"!==o.nodeName&&"TEXTAREA"!==o.nodeName&&0!==o.length){var r={type:"ui.click",data:{path:_(o),message:""}};if(!r.data.path)return;var a=f();m(p({},a,{t:"behavior",behavior:r}))}}function j(e){var t;try{t=e.target}catch(e){t="<unknown>"}if(("INPUT"===t.nodeName||"TEXTAREA"===t.nodeName)&&0!==t.length){var n={type:"ui.blur",data:{path:_(t),message:t.value}};if(!n.data.path||!n.data.message)return;var o=f();m(p({},o,{t:"behavior",behavior:n}))}}var x=["","fetchStart","domainLookupStart","domainLookupEnd","connectStart","connectEnd","requestStart","responseStart","responseEnd","","domInteractive","","domContentLoadedEventEnd","","loadEventStart","","msFirstPaint","secureConnectionStart"];function S(e){var t=v.enableSPA?w(location.hash.toLowerCase()):location.pathname.toLowerCase();t&&A(t,!1)}function C(e){var t=v.enableSPA?w(e.detail.toLowerCase()):e.detail.toLowerCase();t&&A(t,!1)}function A(e,t){t||T(),function(e){var t=f();m(p({},t,{t:"behavior",behavior:{type:"navigation",data:{from:t.page,to:e}}}))}(e),setTimeout(function(){i&&window.parent.postMessage({t:"setPage",href:location.href,page:e},"*"),function(e){s.page=e}(e),s.sid=o(),s.sBegin=Date.now(),function(){if(v.autoSendPv){var e=f();m(p({},e,{t:"pv",dt:document.title,dl:location.href,dr:document.referrer,dpr:window.devicePixelRatio,de:document.charset}))}}()},300)}function T(){var e=s._health.errcount?0:1,t=f(),n=p({},t,s._health,{t:"health",healthy:e,stay:Date.now()-s.sBegin});s._health={errcount:0,apisucc:0,apifail:0},m(n)}function k(e){switch(e.type){case"error":e instanceof ErrorEvent?function(e){var t=f(),n=e.name||"CustomError",o=e.message||"",r=e.error.stack||"";m(p({},t,{t:"error",st:"caughterror",cate:n,msg:o&&o.substring(0,1e3),detail:r&&r.substring(0,1e3),file:e.filename||"",line:e.lineno||"",col:e.colno||""}))}(e):function(e){var t=f(),n=e.target;m(p({},t,{t:"error",st:"resource",msg:n.outerHTML,file:n.src,stack:n.localName.toUpperCase()}))}(e);break;case"unhandledrejection":!function(e){var t=f();m(p({},t,{t:"error",st:"promise",msg:e.reason}))}(e)}u("error")}function P(){var e=window.performance;if(!e||"object"!=typeof e||"function"!=typeof e.getEntriesByType)return null;var t=f(),a=p({},t,{dom:0,load:0,t:"res",res:[]}),i=e.timing||{},n=e.getEntriesByType("resource")||[];if("function"==typeof window.PerformanceNavigationTiming){var o=e.getEntriesByType("navigation")[0];o&&(i=o)}l({dom:[10,8],load:[14,1]},function(e,t){var n=i[x[e[1]]],o=i[x[e[0]]];if(0<n&&0<o){var r=Math.round(o-n);0<=r&&r<36e5&&(a[t]=r)}}),n=n.filter(function(t){return!(-1<c("ignore").ignoreApis.findIndex(function(e){return-1<t.name.indexOf(e)}))}),a.res=n,m(a)}function N(t,e,n,o,r,a){if(t){u("api",e);var i=f(),s=p({},i,{t:"api",beigin:a,url:t,success:e,time:n,code:o,msg:r});-1<c("ignore").ignoreApis.findIndex(function(e){return-1<t.indexOf(e)})||m(s)}else y("[retcode] api is null")}function B(e){var t=document.getElementsByClassName(b);if(0<t.length)for(var n=0;n<t.length;n++)t[n].className=t[n].className.replace(/ bombayjs-circle-active/g,"");e.target.className+=" "+b}function M(){!function(){var t="."+b+"{border: #ff0000 2px solid;}",n=document.createElement("style");n.type="text/css",n.id=L;try{n.appendChild(document.createTextNode(t))}catch(e){n.styleSheet.cssText=t}document.getElementsByTagName("head")[0].appendChild(n)}(),s.cssInserted=!0,s.circle=!0,t("mouseover",B)}function H(){!function(){var e=document.getElementById(L);e.parentNode.removeChild(e)}(),s.cssInserted=!1,s.circle=!1,e("mouseover",B)}function I(e){e.data&&e.data.t&&("setCircle"===e.data.t?Boolean(e.data.v)?M():H():"back"===e.data.t?window.history.back():"forward"===e.data.t&&window.history.forward())}function O(l){var f=history[l];"function"==typeof f&&(history[l]=function(e,t,n){window.__bb_onpopstate_||(window.__bb_onpopstate_=window.onpopstate,window.onpopstate=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];if(A(v.enableSPA?w(location.hash.toLowerCase()):location.pathname.toLowerCase(),!1),window.__bb_onpopstate_)return window.__bb_onpopstate_.apply(this,t)});var o=1===arguments.length?[e]:Array.apply(null,arguments),r=location.href,a=f.apply(history,o);if(!n||"string"!=typeof n)return a;if(n===r)return a;try{var i=r.split("#"),s=n.split("#"),c=g(i[0]),u=g(s[0]),d=i[1]&&i[1].replace(/^\/?(.*)/,"$1"),p=s[1]&&s[1].replace(/^\/?(.*)/,"$1");c!==u?h("historystatechanged",u):d!==p&&h("historystatechanged",p)}catch(e){y("[retcode] error in "+l+": "+e)}return a},history[l].toString=function(e){return function(){return e+"() { [native code] }"}}(l))}function U(){!function(){if("function"==typeof window.fetch){var r=window.fetch;window.__oFetch_=r,window.fetch=function(e,t){var n=1===arguments.length?[e]:Array.apply(null,arguments),a=Date.now(),o=(e&&"string"!=typeof e?e.url:e)||"",i=g(o);return i?r.apply(window,n).then(function(e){var t=e.clone(),n=t.headers;if(n&&"function"==typeof n.get){var o=n.get("content-type");if(o&&!/(text)|(json)/.test(o))return e}var r=Date.now()-a;return t.text().then(function(e){t.ok?N(i,!0,r,status,e.substr(0,1e3)||"",a):N(i,!1,r,status,e.substr(0,1e3)||"",a)}),e}):r.apply(window,n)}}}(),function(){if("function"==typeof window.XMLHttpRequest){var a=0,i="",n=window.XMLHttpRequest;window.__oXMLHttpRequest_=n,window.XMLHttpRequest=function(e){var o=new n(e);if(!o.addEventListener)return o;var r=o.open,t=o.send;return o.open=function(e,t){var n=1===arguments.length?[e]:Array.apply(null,arguments);i=g(t=t),r.apply(o,n)},o.send=function(){a=Date.now();var e=1===arguments.length?[arguments[0]]:Array.apply(null,arguments);t.apply(o,e)},o.onreadystatechange=function(){if(i&&4===o.readyState){var e=Date.now()-a;if(200<=o.status&&o.status<=299){var t=o.status||200;if("function"==typeof o.getResponseHeader){var n=o.getResponseHeader("Content-Type");if(n&&!/(text)|(json)/.test(n))return}N(i,!0,e,t,o.responseText.substr(0,v.maxLength)||"",a)}else N(i,!1,e,t||"FAILED",o.responseText.substr(0,v.maxLength)||"",a)}},o}}}()}function D(e,t){this.init(e)}return D.prototype.init=function(e){!e||e.token?(function(e){v=p({},v,e)}(e),A(v.enableSPA?w(location.hash.toLowerCase()):location.pathname.toLowerCase(),!0),v.isPage&&this.sendPerf(),v.enableSPA&&this.addListenRouterChange(),v.isError&&this.addListenJs(),v.isAjax&&this.addListenAjax(),v.isRecord&&this.addRrweb(),v.isBehavior&&this.addListenBehavior(),v.isResource&&this.sendResource(),(window.__bb=this).addListenUnload(),t("message",I),s.circle&&M()):console.warn("请输入一个token")},D.prototype.sendPerf=function(){!function(){var e=window.performance;if(e&&"object"==typeof e){var a={},i=e.timing||{},t=Date.now(),s=1;if("function"==typeof window.PerformanceNavigationTiming){var n=e.getEntriesByType("navigation")[0];n&&(i=n,s=2)}l({dns:[3,2],tcp:[5,4],ssl:[5,17],ttfb:[7,6],trans:[8,7],dom:[10,8],res:[14,12],firstbyte:[7,2],fpt:[8,1],tti:[10,1],ready:[12,1],load:[14,1]},function(e,t){var n=i[x[e[1]]],o=i[x[e[0]]];if(2===s||0<n&&0<o){var r=Math.round(o-n);0<=r&&r<36e5&&(a[t]=r)}});var o=window.navigator.connection,r=e.navigation||{type:void 0};a.ct=o?o.effectiveType||o.type:"";var c=o&&(o.downlink||o.downlinkMax||o.bandwidth)||null;if((c=999<c?999:c)&&(a.bandwidth=c),a.navtype=1===r.type?"Reload":"Other",1===s&&0<i[x[16]]&&0<i[x[1]]){var u=i[x[16]]-i[x[1]];0<=u&&u<36e5&&(a.fpt=u)}1===s&&0<i[x[1]]?a.begin=i[x[1]]:2===s&&0<a.load?a.begin=t-a.load:a.begin=t;var d=f();m(p({},d,{t:"perf"},a))}}()},D.prototype.sendResource=function(){"complete"===window.document.readyState?P():this.addListenResource()},D.prototype.addListenResource=function(){t("load",P)},D.prototype.addListenBehavior=function(){!function(){if(window&&window.console)for(var e=v.behavior.console,t=0;e.length;t++){var n=e[t],o=window.console[n];if(!window.console[n])return;!function(r,a){window.console[r]=function(){var e,t,n=Array.prototype.slice.apply(arguments),o={type:"console",data:{level:r,message:JSON.stringify(n)}};e=o,t=f(),m(p({},t,{t:"behavior",behavior:e})),a&&a.apply(null,n)}}(n,o)}}(),v.behavior.click&&this.addListenClick()},D.prototype.addListenClick=function(){t("click",R),t("blur",j)},D.prototype.addListenRouterChange=function(){O("pushState"),O("replaceState"),t("hashchange",S),t("historystatechanged",C)},D.prototype.addListenJs=function(){t("error",k),t("unhandledrejection",k)},D.prototype.addListenAjax=function(){U()},D.prototype.addListenUnload=function(){t("beforeunload",T),this.destroy()},D.prototype.addRrweb=function(){},D.prototype.removeListenRouterChange=function(){e("hashchange",S),e("historystatechanged",C)},D.prototype.removeListenJs=function(){e("error",k),e("unhandledrejection",k)},D.prototype.removeListenResource=function(){e("beforeunload",T)},D.prototype.removeListenAjax=function(){},D.prototype.removeListenUnload=function(){e("load",P)},D.prototype.removeRrweb=function(){},D.prototype.sum=function(e,t){!function(e,t){void 0===t&&(t=1);var n=f(),o=a(e);m(p({},n,o,{t:"sum",val:t}))}(e,t)},D.prototype.avg=function(e,t){!function(e,t){void 0===t&&(t=1);var n=f(),o=a(e);m(p({},n,o,{t:"avg",val:t}))}(e,t)},D.prototype.msg=function(e){!function(e){var t=f(),n=a(e);m(p({},t,{t:"msg",group:n.group,msg:n.key.substr(0,v.maxLength)}))}(e)},D.prototype.api=function(e,t,n,o,r){N(e,t,n,o,r,Date.now())},D.prototype.destroy=function(){v.enableSPA&&this.removeListenRouterChange(),v.isError&&this.removeListenJs(),v.isAjax&&this.removeListenAjax(),v.isRecord&&this.removeRrweb(),v.isResource&&this.removeListenResource(),this.removeListenResource()},D});
