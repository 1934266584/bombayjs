!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).Bombay=t()}(this,function(){"use strict";var l=function(){return(l=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)},v={reportUrl:"http://localhost:7002",token:"",appVersion:"1.0.0",environment:"production",outtime:300,enableSPA:!0,autoSendPv:!0,isPage:!0,isAjax:!0,isResource:!0,isError:!0,isRecord:!0,isBehavior:!0,ignore:{ignoreErrors:[],ignoreUrls:[],ignoreApis:["/api/v1/report/web","livereload.js?snipver=1","/sockjs-node/info"]},behavior:{console:["log","error"],click:!0},maxLength:1e3};function c(e){return e&&v[e]?v[e]:{}}function n(){}function a(){for(var e,t,n=20,o=new Array(n),r=Date.now().toString(36).split("");0<n--;)t=(e=36*Math.random()|0).toString(36),o[n]=e%3?t:t.toUpperCase();for(var a=0;a<8;a++)o.splice(3*a+2,0,r[a]);return o.join("")}function o(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&")}function f(e,t){var n,o,r,a=0,i=e.length;if(n=e,o="Array",r=Object.prototype.toString.call(n).substring(8).replace("]",""),o?r===o:r)for(;a<i&&!1!==t.call(e[a],e[a],a);a++);else for(var s in e)if(!1===t.call(e[s],e[s],s))break;return e}function h(e,t){var n;window.CustomEvent?n=new CustomEvent(e,{detail:t}):((n=window.document.createEvent("HTMLEvents")).initEvent(e,!1,!0),n.detail=t),window.dispatchEvent(n)}function r(e){var t=e.split("::");return 1<t.length?{group:t[0],key:t[1]}:{group:"default_group",key:t[0]}}var i=function(n,o,r){window.addEventListener?window.addEventListener(n,function e(t){r&&window.removeEventListener(n,e,!0),o.call(this,t)},!0):window.attachEvent&&window.attachEvent("on"+n,function e(t){r&&window.detachEvent("on"+n,e),o.call(this,t)})},t=function(e,t){return t&&(window.removeEventListener?window.removeEventListener(e,t):window.detachEvent&&window.detachEvent(e,t)),this},w=function(e){return(e?g(e.replace(/^#\/?/,"")):"")||"[index]"},g=function(e){return e&&"string"==typeof e?e.replace(/^(https?:)?\/\//,"").replace(/\?.*$/,""):""},y=function(){var e="object"==typeof console?console.warn:n;try{var t={warn:e};t.warn.call(t)}catch(e){return n}return e}(),d=function(e,o){return e.reduce(function(e,t,n){return o(t,n)?n:e},-1)},s=self!=top,u={page:"",sid:"",sBegin:Date.now(),_health:{errcount:0,apisucc:0,apifail:0},circle:!1,cssInserted:!1};function p(e,t){"error"===e&&u._health.errcount++,"api"===e&&t&&u._health.apisucc++,"api"!==e||t||u._health.apifail++}function m(){var e,t,n=navigator.connection;return{t:"",page:u.page?u.page:location.pathname.toLowerCase(),times:1,v:v.appVersion,token:v.token,e:v.environment,begin:(new Date).getTime(),uid:function(){var e=localStorage.getItem("bombay_uid")||"";e||(e=a(),localStorage.setItem("bombay_uid",e));return e}(),sid:u.sid,sr:screen.width+"x"+screen.height,vp:(e=document.documentElement.clientWidth||document.body.clientWidth,t=document.documentElement.clientHeight||document.body.clientHeight,e+"x"+t),ct:n?n.effectiveType:"",ul:(navigator.language||navigator.userLanguage).substr(0,2),_v:"1.0.9",o:location.href}}function b(e){var t;return"res"!==e.t&&"error"!==e.t&&"behavior"!==e.t&&"health"===e.t&&window&&window.navigator&&"function"==typeof window.navigator.sendBeacon?("object"==typeof(t=e)&&(t=o(t)),t=v.reportUrl+"?"+t,window&&window.navigator&&"function"==typeof window.navigator.sendBeacon?window.navigator.sendBeacon(t):y("[arms] navigator.sendBeacon not surported")):L(e),this}function L(e){var t,n=e[e.t];delete e[e.t],function(e,t){var n=window.__oXMLHttpRequest_||window.XMLHttpRequest;if("function"==typeof n)try{var o=new n;o.open("POST",e,!0),o.setRequestHeader("Content-Type","text/plain"),o.send(JSON.stringify(t))}catch(e){y("[bombayjs] Failed to log, POST请求失败")}else y("[bombayjs] Failed to log, 浏览器不支持XMLHttpRequest")}(v.reportUrl+"?"+o(e),((t={})[e.t]=n,t))}var E="bombayjs-circle-active",S="bombayjs-circle-css";function _(e){var t,n,o,r,a,i=[];if(!e||!e.tagName)return"";if(i.push(e.tagName.toLowerCase()),e.id&&i.push("#".concat(e.id)),(t=e.className)&&"[object String]"===Object.prototype.toString.call(t))for(n=t.split(/\s+/),a=0;a<n.length;a++)n[a].indexOf("active")<0&&i.push(".".concat(n[a]));var s=["type","name","title","alt"];for(a=0;a<s.length;a++)o=s[a],(r=e.getAttribute(o))&&i.push("[".concat(o,'="').concat(r,'"]'));return i.join("")}function R(e){if(!e||1!==e.nodeType)return"";var t=[],n=0,o="";t.push("("+e.innerText.substr(0,50)+")");for(var r=e||null;r&&n++<5&&"html"!==(o=_(r));)t.push(o),r=r.parentNode;return t.reverse().join(" > ")}function e(e){if(u.circle){var t=e.target.className.split(/\s+/),n=R(e.target);return n=1===t.length||2===t.length&&""===t[0]?n.replace(/\.\.bombayjs-circle-active/,""):n.replace(/\.bombayjs-circle-active/,""),window.parent.postMessage({t:"setElmPath",path:n,page:u.page},"*"),void e.stopPropagation()}var o;try{o=e.target}catch(e){o="<unknown>"}if("INPUT"!==o.nodeName&&"TEXTAREA"!==o.nodeName&&0!==o.length){var r={type:"ui.click",data:{path:R(o),message:""}};if(!r.data.path)return;var a=m();b(l(l({},a),{t:"behavior",behavior:r}))}}function j(e){var t;try{t=e.target}catch(e){t="<unknown>"}if(("INPUT"===t.nodeName||"TEXTAREA"===t.nodeName)&&0!==t.length){var n={type:"ui.blur",data:{path:R(t),message:t.value}};if(!n.data.path||!n.data.message)return;var o=m();b(l(l({},o),{t:"behavior",behavior:n}))}}var C=["","fetchStart","domainLookupStart","domainLookupEnd","connectStart","connectEnd","requestStart","responseStart","responseEnd","","domInteractive","","domContentLoadedEventEnd","","loadEventStart","","msFirstPaint","secureConnectionStart"];function T(e){var t=v.enableSPA?w(location.hash.toLowerCase()):location.pathname.toLowerCase();t&&k(t,!1)}function x(e){var t=v.enableSPA?w(e.detail.toLowerCase()):e.detail.toLowerCase();t&&k(t,!1)}function k(e,t){var n,o,r;t||A(),n=e,o=m(),b(l(l({},o),{t:"behavior",behavior:{type:"navigation",data:{from:o.page,to:n}}})),s&&window.parent.postMessage({t:"setPage",href:location.href,page:e},"*"),r=e,u.page=r,u.sid=a(),u.sBegin=Date.now(),function(){if(v.autoSendPv){var e=m();b(l(l({},e),{t:"pv",dt:document.title,dl:location.href,dr:document.referrer,dpr:window.devicePixelRatio,de:document.charset}))}}()}function A(){var e=u._health.errcount?0:1,t=m(),n=l(l(l({},t),u._health),{t:"health",healthy:e,stay:Date.now()-u.sBegin});u._health={errcount:0,apisucc:0,apifail:0},b(n)}function P(e){switch(e.type){case"error":e instanceof ErrorEvent?(i=e,s=m(),c=i.name||"CustomError",d=i.message||"",u=i.error.stack||"",b(l(l({},s),{t:"error",st:"caughterror",cate:c,msg:d&&d.substring(0,1e3),detail:u&&u.substring(0,1e3),file:i.filename||"",line:i.lineno||"",col:i.colno||""}))):(o=e,r=m(),a=o.target,b(l(l({},r),{t:"error",st:"resource",msg:a.outerHTML,file:a.src,stack:a.localName.toUpperCase()})));break;case"unhandledrejection":t=e,n=m(),b(l(l({},n),{t:"error",st:"promise",msg:t.reason}))}var t,n,o,r,a,i,s,c,d,u;p("error")}function N(){var e=window.performance;if(!e||"object"!=typeof e||"function"!=typeof e.getEntriesByType)return null;var t=m(),a=l(l({},t),{dom:0,load:0,t:"res",res:[]}),i=e.timing||{},n=e.getEntriesByType("resource")||[];if("function"==typeof window.PerformanceNavigationTiming){var o=e.getEntriesByType("navigation")[0];o&&(i=o)}if(f({dom:[10,8],load:[14,1]},function(e,t){var n=i[C[e[1]]],o=i[C[e[0]]];if(void 0!==n&&void 0!==o){var r=Math.round(o-n);0<=r&&r<36e5&&(a[t]=r)}}),n=n.filter(function(t){return!(-1<d(c("ignore").ignoreApis,function(e){return-1<t.name.indexOf(e)}))}),-1<navigator.userAgent.indexOf("Edge")){var r=[];f(n,function(e){r.push({connectEnd:e.connectEnd,connectStart:e.connectStart,domainLookupEnd:e.connectStart,domainLookupStart:e.domainLookupStart,duration:e.duration,entryType:e.entryType,fetchStart:e.fetchStart,initiatorType:e.initiatorType,name:e.name,redirectEnd:e.redirectEnd,redirectStart:e.redirectStart,responseEnd:e.responseEnd,responseStart:e.responseStart,startTime:e.startTime})}),n=r}a.res=n,b(a)}function B(t,e,n,o,r,a){if(t){p("api",e);var i=m(),s=l(l({},i),{t:"api",beigin:a,url:t,success:e,time:n,code:o,msg:r});-1<d(c("ignore").ignoreApis,function(e){return-1<t.indexOf(e)})||b(s)}else y("[retcode] api is null")}function M(e){var t=document.getElementsByClassName(E);if(0<t.length)for(var n=0;n<t.length;n++)t[n].className=t[n].className.replace(/ bombayjs-circle-active/g,"");e.target.className+=" "+E}function O(){!function(){var t="."+E+"{border: #ff0000 2px solid;}",n=document.createElement("style");n.type="text/css",n.id=S;try{n.appendChild(document.createTextNode(t))}catch(e){n.styleSheet.cssText=t}document.getElementsByTagName("head")[0].appendChild(n)}(),u.cssInserted=!0,u.circle=!0,i("mouseover",M)}function H(){var e;(e=document.getElementById(S)).parentNode.removeChild(e),u.cssInserted=!1,u.circle=!1,t("mouseover",M)}function I(e){e.data&&e.data.t&&("setCircle"===e.data.t?(Boolean(e.data.v)?O:H)():"back"===e.data.t?window.history.back():"forward"===e.data.t&&window.history.forward())}function U(){if(window&&window.console)for(var e=v.behavior.console,t=0;e.length;t++){var n=e[t],o=window.console[n];if(!window.console[n])return;!function(r,a){window.console[r]=function(){var e,t,n=Array.prototype.slice.apply(arguments),o={type:"console",data:{level:r,message:JSON.stringify(n)}};e=o,t=m(),b(l(l({},t),{t:"behavior",behavior:e})),a&&a.apply(null,n)}}(n,o)}}function D(l){var e,f=history[l];"function"==typeof f&&(history[l]=function(e,t,n){window.__bb_onpopstate_||(window.__bb_onpopstate_=window.onpopstate,window.onpopstate=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];if(k(v.enableSPA?w(location.hash.toLowerCase()):location.pathname.toLowerCase(),!1),window.__bb_onpopstate_)return window.__bb_onpopstate_.apply(this,t)});var o=1===arguments.length?[e]:Array.apply(null,arguments),r=location.href,a=f.apply(history,o);if(!n||"string"!=typeof n)return a;if(n===r)return a;try{var i=r.split("#"),s=n.split("#"),c=g(i[0]),d=g(s[0]),u=i[1]&&i[1].replace(/^\/?(.*)/,"$1"),p=s[1]&&s[1].replace(/^\/?(.*)/,"$1");c!==d?h("historystatechanged",d):u!==p&&h("historystatechanged",p)}catch(e){y("[retcode] error in "+l+": "+e)}return a},history[l].toString=(e=l,function(){return e+"() { [native code] }"}))}function q(){!function(){if("function"==typeof window.fetch){var r=window.fetch;window.__oFetch_=r,window.fetch=function(e,t){var n=1===arguments.length?[e]:Array.apply(null,arguments),a=Date.now(),o=(e&&"string"!=typeof e?e.url:e)||"",i=g(o);return i?r.apply(window,n).then(function(e){var t=e.clone(),n=t.headers;if(n&&"function"==typeof n.get){var o=n.get("content-type");if(o&&!/(text)|(json)/.test(o))return e}var r=Date.now()-a;return t.text().then(function(e){t.ok?B(i,!0,r,status,e.substr(0,1e3)||"",a):B(i,!1,r,status,e.substr(0,1e3)||"",a)}),e}):r.apply(window,n)}}}(),function(){if("function"==typeof window.XMLHttpRequest){var a=0,i="",n=window.XMLHttpRequest;window.__oXMLHttpRequest_=n,window.XMLHttpRequest=function(e){var o=new n(e);if(!o.addEventListener)return o;var r=o.open,t=o.send;return o.open=function(e,t){var n=1===arguments.length?[e]:Array.apply(null,arguments);i=g(t=t),r.apply(o,n)},o.send=function(){a=Date.now();var e=1===arguments.length?[arguments[0]]:Array.apply(null,arguments);t.apply(o,e)},o.onreadystatechange=function(){if(i&&4===o.readyState){var e=Date.now()-a;if(200<=o.status&&o.status<=299){var t=o.status||200;if("function"==typeof o.getResponseHeader){var n=o.getResponseHeader("Content-Type");if(n&&!/(text)|(json)/.test(n))return}B(i,!0,e,t,o.responseText.substr(0,v.maxLength)||"",a)}else B(i,!1,e,t||"FAILED",o.responseText.substr(0,v.maxLength)||"",a)}},o}}}()}function X(e,t){this.init(e)}return X.prototype.init=function(e){var t;!e||e.token?(t=e,k((v=l(l({},v),t)).enableSPA?w(location.hash.toLowerCase()):location.pathname.toLowerCase(),!0),v.isPage&&this.sendPerf(),v.enableSPA&&this.addListenRouterChange(),v.isError&&this.addListenJs(),v.isAjax&&this.addListenAjax(),v.isRecord&&this.addRrweb(),v.isBehavior&&this.addListenBehavior(),v.isResource&&this.sendResource(),(window.__bb=this).addListenUnload(),i("message",I),u.circle&&O()):console.warn("请输入一个token")},X.prototype.sendPerf=function(){!function(){var i=window.performance;if(i&&"object"==typeof i)var s={dns:0,tcp:0,ssl:0,ttfb:0,trans:0,dom:0,res:0,firstbyte:0,fpt:0,tti:0,ready:0,load:0},c=i.timing||{},d=Date.now(),u=1,p=setInterval(function(){if(c.loadEventEnd){if(clearInterval(p),"function"==typeof window.PerformanceNavigationTiming){var e=i.getEntriesByType("navigation")[0];e&&(c=e,u=2)}f({dns:[3,2],tcp:[5,4],ssl:[5,17],ttfb:[7,6],trans:[8,7],dom:[10,8],res:[14,12],firstbyte:[7,2],fpt:[8,1],tti:[10,1],ready:[12,1],load:[14,1]},function(e,t){var n=c[C[e[1]]],o=c[C[e[0]]],r=Math.round(o-n);(2===u||void 0!==n&&void 0!==o)&&("dom"===t&&(r=Math.round(o-n)),0<=r&&r<36e5&&(s[t]=r))});var t=window.navigator.connection||window.navigator.mozConnection||window.navigator.webkitConnection,n=i.navigation||{type:void 0};s.ct=t?t.effectiveType||t.type:"";var o=t&&(t.downlink||t.downlinkMax||t.bandwidth)||null;if((o=999<o?999:o)&&(s.bandwidth=o),s.navtype=1===n.type?"Reload":"Other",1===u&&0<c[C[16]]&&0<c[C[1]]){var r=c[C[16]]-c[C[1]];0<=r&&r<36e5&&(s.fpt=r)}1===u&&0<c[C[1]]?s.begin=c[C[1]]:2===u&&0<s.load?s.begin=d-s.load:s.begin=d;var a=m();b(l(l(l({},a),{t:"perf"}),s))}},50)}()},X.prototype.sendResource=function(){"complete"===window.document.readyState?N():this.addListenResource()},X.prototype.addListenResource=function(){i("load",N)},X.prototype.addListenBehavior=function(){U(),v.behavior.click&&this.addListenClick()},X.prototype.addListenClick=function(){i("click",e),i("blur",j)},X.prototype.addListenRouterChange=function(){D("pushState"),D("replaceState"),i("hashchange",T),i("historystatechanged",x)},X.prototype.addListenJs=function(){i("error",P),i("unhandledrejection",P)},X.prototype.addListenAjax=function(){q()},X.prototype.addListenUnload=function(){i("beforeunload",A),this.destroy()},X.prototype.addRrweb=function(){},X.prototype.removeListenRouterChange=function(){t("hashchange",T),t("historystatechanged",x)},X.prototype.removeListenJs=function(){t("error",P),t("unhandledrejection",P)},X.prototype.removeListenResource=function(){t("beforeunload",A)},X.prototype.removeListenAjax=function(){},X.prototype.removeListenUnload=function(){t("load",N)},X.prototype.removeRrweb=function(){},X.prototype.sum=function(e,t){!function(e,t){void 0===t&&(t=1);var n=m(),o=r(e);b(l(l(l({},n),o),{t:"sum",val:t}))}(e,t)},X.prototype.avg=function(e,t){!function(e,t){void 0===t&&(t=1);var n=m(),o=r(e);b(l(l(l({},n),o),{t:"avg",val:t}))}(e,t)},X.prototype.msg=function(e){var t,n,o;t=e,n=m(),o=r(t),b(l(l({},n),{t:"msg",group:o.group,msg:o.key.substr(0,v.maxLength)}))},X.prototype.api=function(e,t,n,o,r){B(e,t,n,o,r,Date.now())},X.prototype.destroy=function(){v.enableSPA&&this.removeListenRouterChange(),v.isError&&this.removeListenJs(),v.isAjax&&this.removeListenAjax(),v.isRecord&&this.removeRrweb(),v.isResource&&this.removeListenResource(),this.removeListenResource()},X});
