{"code":"import { __rest } from \"tslib\";\r\nimport { Config, setConfig } from \"./config\";\r\nimport { handleErr, handleVueErr, handlePerf, handleHashchange, handleHistorystatechange, handleClick, handleBlur, handleResource, handleSum, handleAvg, handleMsg, handleHealth, handleApi, setPage, listenMessageListener, listenCircleListener } from \"./handlers\";\r\nimport { on, off, parseHash } from \"./utils/tools\";\r\nimport { hackState, hackConsole, hackhook } from \"./hack\";\r\nimport { GlobalVal } from \"./config/global\";\r\nvar Bombay = /** @class */ (function () {\r\n    function Bombay(options, fn) {\r\n        this.init(options);\r\n    }\r\n    Bombay.prototype.init = function (_a) {\r\n        var Vue = _a.Vue, options = __rest(_a, [\"Vue\"]);\r\n        // 没有token,则不监听任何事件\r\n        if (options && !options.token) {\r\n            console.warn(\"请输入一个token\");\r\n            return;\r\n        }\r\n        Vue && this.addListenVueError(Vue);\r\n        setConfig(options);\r\n        var page = Config.enableSPA\r\n            ? parseHash(location.hash.toLowerCase())\r\n            : location.pathname.toLowerCase();\r\n        setPage(page, true);\r\n        Config.isPage && this.sendPerf();\r\n        Config.enableSPA && this.addListenRouterChange();\r\n        Config.isError && this.addListenJs();\r\n        Config.isAjax && this.addListenAjax();\r\n        Config.isRecord && this.addRrweb();\r\n        // 行为是一个页面内的操作\r\n        Config.isBehavior && this.addListenBehavior();\r\n        Config.isResource && this.sendResource();\r\n        // 绑定全局变量\r\n        window.__bb = this;\r\n        this.addListenUnload();\r\n        // 监听message\r\n        listenMessageListener();\r\n        if (GlobalVal.circle) {\r\n            listenCircleListener();\r\n        }\r\n    };\r\n    Bombay.prototype.sendPerf = function () {\r\n        handlePerf();\r\n    };\r\n    // 发送资源\r\n    Bombay.prototype.sendResource = function () {\r\n        \"complete\" === window.document.readyState\r\n            ? handleResource()\r\n            : this.addListenResource();\r\n    };\r\n    // 监听资源\r\n    Bombay.prototype.addListenResource = function () {\r\n        on(\"load\", handleResource);\r\n    };\r\n    // 监听行为\r\n    Bombay.prototype.addListenBehavior = function () {\r\n        hackConsole();\r\n        Config.behavior.click && this.addListenClick();\r\n    };\r\n    // 监听click\r\n    Bombay.prototype.addListenClick = function () {\r\n        on(\"click\", handleClick); // 非输入框点击，会过滤掉点击输入框\r\n        on(\"blur\", handleBlur); // 输入框失焦\r\n    };\r\n    // 监听路由\r\n    Bombay.prototype.addListenRouterChange = function () {\r\n        hackState(\"pushState\");\r\n        hackState(\"replaceState\");\r\n        on(\"hashchange\", handleHashchange);\r\n        on(\"historystatechanged\", handleHistorystatechange);\r\n    };\r\n    Bombay.prototype.addListenVueError = function (Vue) {\r\n        Vue.config.errorHandler = function (error, vm, info) {\r\n            console.error(error);\r\n            handleVueErr(error, vm, info);\r\n        };\r\n    };\r\n    Bombay.prototype.addListenJs = function () {\r\n        // js错误或静态资源加载错误\r\n        on(\"error\", handleErr);\r\n        //promise错误\r\n        on(\"unhandledrejection\", handleErr);\r\n        // window.addEventListener('rejectionhandled', rejectionhandled, true);\r\n    };\r\n    Bombay.prototype.addListenAjax = function () {\r\n        hackhook();\r\n    };\r\n    // beforeunload\r\n    Bombay.prototype.addListenUnload = function () {\r\n        on(\"beforeunload\", handleHealth);\r\n        this.destroy();\r\n    };\r\n    Bombay.prototype.addRrweb = function () { };\r\n    // 移除路由\r\n    Bombay.prototype.removeListenRouterChange = function () {\r\n        off(\"hashchange\", handleHashchange);\r\n        off(\"historystatechanged\", handleHistorystatechange);\r\n    };\r\n    Bombay.prototype.removeListenJs = function () {\r\n        off(\"error\", handleErr);\r\n        off(\"unhandledrejection\", handleErr);\r\n    };\r\n    // 监听资源\r\n    Bombay.prototype.removeListenResource = function () {\r\n        off(\"beforeunload\", handleHealth);\r\n    };\r\n    Bombay.prototype.removeListenAjax = function () { };\r\n    Bombay.prototype.removeListenUnload = function () {\r\n        off(\"load\", handleResource);\r\n    };\r\n    Bombay.prototype.removeRrweb = function () { };\r\n    Bombay.prototype.sum = function (key, val) {\r\n        handleSum(key, val);\r\n    };\r\n    Bombay.prototype.avg = function (key, val) {\r\n        handleAvg(key, val);\r\n    };\r\n    Bombay.prototype.msg = function (key) {\r\n        handleMsg(key);\r\n    };\r\n    Bombay.prototype.api = function (api, success, time, code, msg) {\r\n        handleApi(api, success, time, code, msg, Date.now());\r\n    };\r\n    Bombay.prototype.destroy = function () {\r\n        Config.enableSPA && this.removeListenRouterChange();\r\n        Config.isError && this.removeListenJs();\r\n        Config.isAjax && this.removeListenAjax();\r\n        Config.isRecord && this.removeRrweb();\r\n        Config.isResource && this.removeListenResource();\r\n        this.removeListenResource();\r\n    };\r\n    return Bombay;\r\n}());\r\nexport default Bombay;\r\n//# sourceMappingURL=index.js.map","references":["/Users/jing/zoomlion/错误收集前端页面采集代码/src/config/index.ts","/Users/jing/zoomlion/错误收集前端页面采集代码/src/handlers.ts","/Users/jing/zoomlion/错误收集前端页面采集代码/src/utils/tools.ts","/Users/jing/zoomlion/错误收集前端页面采集代码/src/hack.ts","/Users/jing/zoomlion/错误收集前端页面采集代码/src/config/global.ts"],"map":"{\"version\":3,\"file\":\"index.js\",\"sourceRoot\":\"\",\"sources\":[\"../../src/index.ts\"],\"names\":[],\"mappings\":\"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\"}"}
