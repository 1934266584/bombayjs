{"code":"import { parseUrl, fnToString, warn, dispatchCustomEvent, parseHash } from './utils/tools';\r\nimport { handleBehavior, handleApi, setPage, } from './handlers';\r\nimport { Config } from './config';\r\n// hack console\r\n// \"debug\", \"info\", \"warn\", \"log\", \"error\"\r\nexport function hackConsole() {\r\n    if (window && window.console) {\r\n        for (var e = Config.behavior.console, n = 0; e.length; n++) {\r\n            var r = e[n];\r\n            var action = window.console[r];\r\n            if (!window.console[r])\r\n                return;\r\n            (function (r, action) {\r\n                window.console[r] = function () {\r\n                    var i = Array.prototype.slice.apply(arguments);\r\n                    var s = {\r\n                        type: \"console\",\r\n                        data: {\r\n                            level: r,\r\n                            message: JSON.stringify(i),\r\n                        }\r\n                    };\r\n                    handleBehavior(s);\r\n                    action && action.apply(null, i);\r\n                };\r\n            })(r, action);\r\n        }\r\n    }\r\n}\r\n/**\r\n * hack pushstate replaceState\r\n * 派送historystatechange historystatechange事件\r\n * @export\r\n * @param {('pushState' | 'replaceState')} e\r\n */\r\nexport function hackState(e) {\r\n    var t = history[e];\r\n    \"function\" == typeof t && (history[e] = function (n, i, s) {\r\n        !window['__bb_onpopstate_'] && hackOnpopstate(); // 调用pushState或replaceState时hack Onpopstate\r\n        var c = 1 === arguments.length ? [arguments[0]] : Array.apply(null, arguments), u = location.href, f = t.apply(history, c);\r\n        if (!s || \"string\" != typeof s)\r\n            return f;\r\n        if (s === u)\r\n            return f;\r\n        try {\r\n            var l = u.split(\"#\"), h = s.split(\"#\"), p = parseUrl(l[0]), d = parseUrl(h[0]), g = l[1] && l[1].replace(/^\\/?(.*)/, \"$1\"), v = h[1] && h[1].replace(/^\\/?(.*)/, \"$1\");\r\n            p !== d ? dispatchCustomEvent(\"historystatechanged\", d) : g !== v && dispatchCustomEvent(\"historystatechanged\", v);\r\n        }\r\n        catch (m) {\r\n            warn(\"[retcode] error in \" + e + \": \" + m);\r\n        }\r\n        return f;\r\n    }, history[e].toString = fnToString(e));\r\n}\r\nexport function hackhook() {\r\n    hackFetch();\r\n    hackAjax();\r\n}\r\nfunction hackFetch() {\r\n    if (\"function\" == typeof window.fetch) {\r\n        var __oFetch_ = window.fetch;\r\n        window['__oFetch_'] = __oFetch_;\r\n        window.fetch = function (t, o) {\r\n            var a = 1 === arguments.length ? [arguments[0]] : Array.apply(null, arguments);\r\n            var begin = Date.now(), url = (t && \"string\" != typeof t ? t.url : t) || \"\", page = parseUrl(url);\r\n            if (!page)\r\n                return __oFetch_.apply(window, a);\r\n            return __oFetch_.apply(window, a).then(function (e) {\r\n                var response = e.clone(), headers = response.headers;\r\n                if (headers && 'function' === typeof headers.get) {\r\n                    var ct = headers.get('content-type');\r\n                    if (ct && !/(text)|(json)/.test(ct))\r\n                        return e;\r\n                }\r\n                var time = Date.now() - begin;\r\n                response.text().then(function (res) {\r\n                    if (response.ok) {\r\n                        handleApi(page, !0, time, status, res.substr(0, 1000) || '', begin);\r\n                    }\r\n                    else {\r\n                        handleApi(page, !1, time, status, res.substr(0, 1000) || '', begin);\r\n                    }\r\n                });\r\n                return e;\r\n            });\r\n        };\r\n    }\r\n}\r\n// 如果返回过长，会被截断，最长1000个字符\r\nfunction hackAjax() {\r\n    if (\"function\" == typeof window.XMLHttpRequest) {\r\n        var begin = 0, url = '', page = '';\r\n        var __oXMLHttpRequest_ = window.XMLHttpRequest;\r\n        window['__oXMLHttpRequest_'] = __oXMLHttpRequest_;\r\n        window.XMLHttpRequest = function (t) {\r\n            var xhr = new __oXMLHttpRequest_(t);\r\n            if (!xhr.addEventListener)\r\n                return xhr;\r\n            var open = xhr.open, send = xhr.send;\r\n            xhr.open = function (method, url) {\r\n                var a = 1 === arguments.length ? [arguments[0]] : Array.apply(null, arguments);\r\n                url = url;\r\n                page = parseUrl(url);\r\n                open.apply(xhr, a);\r\n            };\r\n            xhr.send = function () {\r\n                begin = Date.now();\r\n                var a = 1 === arguments.length ? [arguments[0]] : Array.apply(null, arguments);\r\n                send.apply(xhr, a);\r\n            };\r\n            xhr.onreadystatechange = function () {\r\n                if (page && 4 === xhr.readyState) {\r\n                    var time = Date.now() - begin;\r\n                    if (xhr.status >= 200 && xhr.status <= 299) {\r\n                        var status = xhr.status || 200;\r\n                        if (\"function\" == typeof xhr.getResponseHeader) {\r\n                            var r = xhr.getResponseHeader(\"Content-Type\");\r\n                            if (r && !/(text)|(json)/.test(r))\r\n                                return;\r\n                        }\r\n                        handleApi(page, !0, time, status, xhr.responseText.substr(0, Config.maxLength) || '', begin);\r\n                    }\r\n                    else {\r\n                        handleApi(page, !1, time, status || 'FAILED', xhr.responseText.substr(0, Config.maxLength) || '', begin);\r\n                    }\r\n                }\r\n            };\r\n            return xhr;\r\n        };\r\n    }\r\n}\r\nexport function hackOnpopstate() {\r\n    window['__bb_onpopstate_'] = window.onpopstate;\r\n    window.onpopstate = function () {\r\n        for (var r = arguments.length, a = new Array(r), o = 0; o < r; o++)\r\n            a[o] = arguments[o];\r\n        var page = Config.enableSPA ? parseHash(location.hash.toLowerCase()) : location.pathname.toLowerCase();\r\n        setPage(page, false);\r\n        if (window.__bb_onpopstate_)\r\n            return window.__bb_onpopstate_.apply(this, a);\r\n    };\r\n}\r\n//# sourceMappingURL=hack.js.map","references":["/Users/jing/zoomlion/错误收集前端页面采集代码/src/utils/tools.ts","/Users/jing/zoomlion/错误收集前端页面采集代码/src/handlers.ts","/Users/jing/zoomlion/错误收集前端页面采集代码/src/config/index.ts"],"map":"{\"version\":3,\"file\":\"hack.js\",\"sourceRoot\":\"\",\"sources\":[\"../../src/hack.ts\"],\"names\":[],\"mappings\":\"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\"}"}
